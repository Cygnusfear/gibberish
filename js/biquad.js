let g = require( 'genish.js' )

module.exports = function( Gibberish ) {

  Gibberish.genish.biquad = ( input, cutoff, Q, mode, isStereo ) => {
    let a0,a1,a2,c,b1,b2,
        in1a0,x1a1,x2a2,y1b1,y2b2,
        in1a0_1,x1a1_1,x2a2_1,y1b1_1,y2b2_1

    let returnValue

    let x1 = ssd(), x2 = ssd(), y1 = ssd(), y2 = ssd()
    
    let w0 = memo( mul( 2 * Math.PI, div( cutoff,  gen.samplerate ) ) ),
        sinw0 = sin( w0 ),
        cosw0 = cos( w0 ),
        alpha = memo( div( sinw0, mul( 2, Q ) ) )

    let oneMinusCosW = sub( 1, cosw0 )

    switch( mode ) {
      case 'HP':
        a0 = memo( div( add( 1, cosw0) , 2) )
        a1 = mul( add( 1, cosw0 ), -1 )
        a2 = a0
        c  = add( 1, alpha )
        b1 = mul( -2 , cosw0 )
        b2 = sub( 1, alpha )
        break;
      case 'BP':
        a0 = mul( Q, alpha )
        a1 = 0
        a2 = mul( a0, -1 )
        c  = add( 1, alpha )
        b1 = mul( -2 , cosw0 )
        b2 = sub( 1, alpha )
        break;
      default: // LP
        a0 = memo( div( oneMinusCosW, 2) )
        a1 = oneMinusCosW
        a2 = a0
        c  = add( 1, alpha )
        b1 = mul( -2 , cosw0 )
        b2 = sub( 1, alpha )
    }

    a0 = div( a0, c ); a1 = div( a1, c ); a2 = div( a2, c )
    b1 = div( b1, c ); b2 = div( b2, c )

    in1a0 = mul( x1.in( isStereo ? input[0] : input    ), a0 )
    x1a1  = mul( x2.in( x1.out ), a1 )
    x2a2  = mul( x2.out,          a2 )

    let sumLeft = add( in1a0, x1a1, x2a2 )

    y1b1 = mul( y2.in( y1.out ), b1 )
    y2b2 = mul( y2.out, b2 )

    let sumRight = add( y1b1, y2b2 )

    let diff = sub( sumLeft, sumRight )

    y1.in( diff )

    if( isStereo ) {
      let x1_1 = ssd(), x2_1 = ssd(), y1_1 = ssd(), y2_1 = ssd()

      in1a0_1 = mul( x1_1.in( input[1]    ), a0 )
      x1a1_1  = mul( x2_1.in( x1_1.out ), a1 )
      x2a2_1  = mul( x2_1.out,          a2 )

      let sumLeft_1 = add( in1a0_1, x1a1_1, x2a2_1 )

      y1b1_1 = mul( y2_1.in( y1_1.out ), b1 )
      y2b2_1 = mul( y2_1.out, b2 )

      let sumRight_1 = add( y1b1_1, y2b2_1 )

      let diff_1 = sub( sumLeft_1, sumRight_1 )
      
      returnValue = [ diff, diff_1 ]
    }else{
      returnValue = diff
    }

    return returnValue
  }

  let Biquad = props => {
    let _props = Object.assign( {}, Biquad.defaults, props ) 

    let isStereo = Array.isArray( props.input )

    let filter = Gibberish.factory( 
      Gibberish.genish.biquad( g.in('input'), g.in('cutoff'), g.in('Q'), _props.mode || 'LP', isStereo ), 
      'biquad', 
      _props
    )
    return filter
  }


  Biquad.defaults = {
    input:0,
    Q: .75,
    cutoff:550,
    mode:'LP'
  }

  return Biquad

}

